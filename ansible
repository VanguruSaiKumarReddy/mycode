# Ensure sudo is present
- name: "CIS 5.3.3 | Install sudo"
  package:
    name: sudo
    state: present
  tags: ['cis_5_3_3','cis','sudo']

# Make sure /etc/sudoers includes /etc/sudoers.d
- name: "CIS 5.3.3 | Ensure /etc/sudoers.d is included"
  lineinfile:
    path: /etc/sudoers
    regexp: '^\s*#?\s*includedir\s+/etc/sudoers\.d\s*$'
    line: '#includedir /etc/sudoers.d'
    state: present
    validate: '/usr/sbin/visudo -cf %s'
  tags: ['cis_5_3_3','cis','sudo']

# Create the log file with tight perms (not strictly required by the control, but safe)
- name: "CIS 5.3.3 | Ensure sudo logfile exists with secure perms"
  file:
    path: "{{ cis_sudo_logfile | default('/var/log/sudo.log') }}"
    state: touch
    owner: root
    group: root
    mode: '0600'
  tags: ['cis_5_3_3','cis','sudo']

# Configure sudo to log to that file via a drop-in
- name: "CIS 5.3.3 | Configure Defaults logfile in sudoers.d"
  copy:
    dest: /etc/sudoers.d/99-cis-sudo-logfile
    owner: root
    group: root
    mode: '0440'
    content: |
      Defaults logfile={{ cis_sudo_logfile | default('/var/log/sudo.log') }}
    validate: '/usr/sbin/visudo -cf %s'
  tags: ['cis_5_3_3','cis','sudo']




# 1) Satisfy the control's regex (presence anywhere in sudoers or sudoers.d)
grep -R --line-number -E '^\s*Defaults\s+logfile\s*=\s*\S+\s*$' /etc/sudoers /etc/sudoers.d

# 2) Check sudoers syntax
visudo -c

# 3) (Optional) confirm logging works
sudo -l >/dev/null 2>&1
tail -n1 /var/log/sudo.log
