#!/usr/bin/env bash
# RHEL 8 + x86_64 only. Minimal EC2 Instance Connect setup.

set -euo pipefail

# --- Download RPMs (us-east-1, linux_amd64) ---
mkdir -p /tmp/eic && cd /tmp/eic
curl -fSLO https://amazon-ec2-instance-connect-us-east-1.s3.us-east-1.amazonaws.com/latest/linux_amd64/ec2-instance-connect-2.0-0.5.rhel8.noarch.rpm
curl -fSLO https://amazon-ec2-instance-connect-us-east-1.s3.us-east-1.amazonaws.com/latest/linux_amd64/ec2-instance-connect-selinux-2.0-0.5.noarch.rpm

# --- Install ---
yum install -y ./ec2-instance-connect-*.rpm

# --- sshd_config (idempotent) ---
SSHD=/etc/ssh/sshd_config
sed -i '/^#\?AuthorizedKeysCommand /d' "$SSHD"
sed -i '/^#\?AuthorizedKeysCommandUser /d' "$SSHD"
sed -i '/^#\?PubkeyAuthentication /d' "$SSHD"

cat <<'EOF' >> "$SSHD"

# EC2 Instance Connect
AuthorizedKeysCommand /opt/aws/bin/eic_run_authorized_keys %u %f
AuthorizedKeysCommandUser ec2-instance-connect
PubkeyAuthentication yes
EOF

# --- Enable & start ---
systemctl enable --now ec2-instance-connect
systemctl restart sshd

# --- Quick check ---
echo "== RPMs =="
rpm -q ec2-instance-connect ec2-instance-connect-selinux || true
echo "== Binaries =="
ls -l /opt/aws/bin/eic_* || true
echo "== Services =="
systemctl is-active ec2-instance-connect sshd && echo "âœ… Done."
