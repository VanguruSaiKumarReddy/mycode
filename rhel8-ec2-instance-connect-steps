#!/usr/bin/env bash
set -euo pipefail

mkdir -p /tmp/ec2-instance-connect && cd /tmp/ec2-instance-connect

# From AWS docs (linux_amd64, RHEL8, x86_64)
curl -O https://amazon-ec2-instance-connect-us-west-2.s3.us-west-2.amazonaws.com/latest/linux_amd64/ec2-instance-connect-2.0.0-5.rhel8.x86_64.rpm
curl -O https://amazon-ec2-instance-connect-us-west-2.s3.us-west-2.amazonaws.com/latest/linux_amd64/ec2-instance-connect-selinux-2.0.0-5.noarch.rpm

sudo yum install -y ./ec2-instance-connect-2.0.0-5.rhel8.x86_64.rpm ./ec2-instance-connect-selinux-2.0.0-5.noarch.rpm

# Update sshd_config
SSHD=/etc/ssh/sshd_config
sudo sed -i '/^#\?AuthorizedKeysCommand /d;/^#\?AuthorizedKeysCommandUser /d;/^#\?PubkeyAuthentication /d' "$SSHD"
sudo tee -a "$SSHD" >/dev/null <<'EOF'

# EC2 Instance Connect
AuthorizedKeysCommand /opt/aws/bin/eic_run_authorized_keys %u %f
AuthorizedKeysCommandUser ec2-instance-connect
PubkeyAuthentication yes
EOF

sudo systemctl enable --now ec2-instance-connect
sudo systemctl restart sshd
