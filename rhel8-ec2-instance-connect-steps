# 1. Make temp dir
mkdir -p /tmp/eic && cd /tmp/eic

# 2. Download Amazonâ€™s official RPMs (RHEL8 x86_64, adjust region if needed)
curl -O https://amazon-ec2-instance-connect-us-east-1.s3.us-east-1.amazonaws.com/latest/linux_amd64/ec2-instance-connect-2.0-0.5.rhel8.noarch.rpm
curl -O https://amazon-ec2-instance-connect-us-east-1.s3.us-east-1.amazonaws.com/latest/linux_amd64/ec2-instance-connect-selinux-2.0-0.5.noarch.rpm

# 3. Install them
sudo yum install -y ./ec2-instance-connect-*.rpm

# 4. Fix sshd_config if lines are missing
sudo bash -c 'cat >>/etc/ssh/sshd_config <<EOF

# Added for EC2 Instance Connect
AuthorizedKeysCommand /opt/aws/bin/eic_run_authorized_keys %u %f
AuthorizedKeysCommandUser ec2-instance-connect
PubkeyAuthentication yes
EOF'

# 5. Enable and start service
sudo systemctl enable --now ec2-instance-connect
sudo systemctl restart sshd
